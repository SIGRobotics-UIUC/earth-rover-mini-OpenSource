# 06-3 GPS定位获取

**Miniplus GPS 模组使用 Quectel LC29HDA, 支持双频、RTK解算、开阔环境精度达到厘米级别**

> 室内以及遮挡严重区域无法获得GPS定位

## 1 LC29H GPS 模组

* 串口波特率 115200
* 串口输入输出语句符合 [NMEA0183 ](https://en.wikipedia.org/wiki/NMEA_0183)格式

## 2 打开GPS输出

* NMEA1083 语句校验

  ```c++
  #include <ostream>
  #include <iostream>
  #include <iomanip>
  #include <sstream>
  
  static unsigned char calculateChecksum(const std::string& sentence) {
      unsigned char checksum = 0;
      for (size_t i = 1; i < sentence.size() && sentence[i] != '*'; ++i) {
          checksum ^= sentence[i];
      }
      return checksum;
  }
  
  static std::string constructNMEASentence(const std::string& baseSentence) {
      unsigned char checksum = calculateChecksum(baseSentence);
      std::ostringstream oss;
      oss << baseSentence << '*' << std::uppercase << std::hex << std::setw(2) << std::setfill('0') << static_cast<int>(checksum) << "\r\n";
      return oss.str();
  }
  ```

* 设置GPS语句输出频率

  ```c++
  int lc29h::Init()
  {
          if (!this->Probe()) { //探测串口设备是否存在
                  std::cout << "Probe failed.\n";
                  return -1;
          }
  
          this->Open(); //打开串口设备
  
          this->Write(constructNMEASentence("$PQTMVERNO")); //查询版本号
          std::string line;
          this->Read(line);
          if (line.empty()) {
                  SPDLOG_WARN("LC29H is not exsit.");
                  return -1;
          }
  
          SPDLOG_INFO("LC29H Version {} ", line);
  
      	//输出频率最高支持20HZ
          this->Write(constructNMEASentence("$PQTMCFGMSGRATE,W,GSV,1")); //以1HZ 频率输出GSV语句
          this->Write(constructNMEASentence("$PQTMCFGMSGRATE,W,RMC,1")); //以1HZ 频率输出RMC语句
          this->Write(constructNMEASentence("$PQTMCFGMSGRATE,W,GSA,0")); //关闭GSA语句输出
          this->Write(constructNMEASentence("$PQTMCFGMSGRATE,W,GLL,0")); //关闭GLL语句输出
          this->Write(constructNMEASentence("$PQTMCFGMSGRATE,W,VTG,0")); //关闭VTG语句输出
          this->Write(constructNMEASentence("$PQTMCFGMSGRATE,W,GGA,1")); //以1HZ 频率输出GGA语句
  
          std::cout << "lc29h Init done." << std::endl;
          exit_ = false;
  
          return 0;
  }
  ```

  

## 2 解析GPS语句

**串口输入输出语句符合 [NMEA0183 ](https://en.wikipedia.org/wiki/NMEA_0183)格式, 可使用开源库[minmea](https://github.com/kosma/minmea) 解析NMEA0183语句, 读取串口以获取GPS定位语句**

```c++
void Ec2x::ParseNmeaSentence(std::string sentence) {
        static float rmc_speed = 0;
        static int rmc_ttff = 0;
        static bool last_sentence_is_gsv = false;
        switch(minmea_sentence_id(sentence.c_str(), false)) {
        case MINMEA_SENTENCE_GGA: {
                struct minmea_sentence_gga frame;
                if (minmea_parse_gga(&frame, sentence.c_str())) {
                        float longitude = minmea_tocoord(&frame.longitude);
                        float latitude = minmea_tocoord(&frame.latitude);
                        float hdop = minmea_tocoord(&frame.hdop);
                        float altitude = minmea_tocoord(&frame.altitude);
                        //SPDLOG_INFO("longitude {} latitude {} hdop {} altitude {} fix_quality {}",ongitude, latitude, hdop, altitude, frame.fix_quality);
                }
        } break;
        default: {
        } break;
        }
}
```

## 3 使用RTK服务实现厘米级定位

**LC29HDA模组支持直接输入RTCM3语句辅助GPS位置解算，提高定位精度**

